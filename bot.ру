import logging
from aiogram import Bot, Dispatcher, types
from aiogram.types import ReplyKeyboardMarkup, KeyboardButton, InputMediaPhoto
from aiogram.utils import executor
from PIL import Image, ImageOps
from io import BytesIO

# ðŸ”¹ Ð¢Ð’ÐžÐ™ Ð¢ÐžÐšÐ•Ð
TOKEN = "8366409670:AAGoyPOkiXIoy90jJntQEH6jOHibqb9Ulcw"

logging.basicConfig(level=logging.INFO)
bot = Bot(token=TOKEN)
dp = Dispatcher(bot)

# Ð¥Ñ€Ð°Ð½Ð¸Ð»Ð¸Ñ‰Ðµ Ð²Ñ‹Ð±Ð¾Ñ€Ð° ÑÐµÑ‚ÐºÐ¸ Ð´Ð»Ñ ÐºÐ°Ð¶Ð´Ð¾Ð³Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
user_grid_choice = {}

# Ð“Ð»Ð°Ð²Ð½Ð¾Ðµ Ð¼ÐµÐ½ÑŽ
menu = ReplyKeyboardMarkup(resize_keyboard=True)
menu.add(
    KeyboardButton("ðŸŸ¦ Ð¡ÐµÑ‚ÐºÐ° 2Ã—2"),
    KeyboardButton("ðŸŸ© Ð¡ÐµÑ‚ÐºÐ° 3Ã—3"),
    KeyboardButton("ðŸŸ¥ Ð¡ÐµÑ‚ÐºÐ° 4Ã—4")
)

@dp.message_handler(commands=["start"])
async def start_cmd(message: types.Message):
    await message.answer(
        "ðŸ‘‹ ÐŸÑ€Ð¸Ð²ÐµÑ‚! Ð¯ Ð½Ð°Ñ€ÐµÐ¶Ñƒ Ñ‚Ð²Ð¾Ñ‘ Ñ„Ð¾Ñ‚Ð¾ Ð½Ð° ÑÐµÑ‚ÐºÑƒ Ñ Ð±ÐµÐ»Ñ‹Ð¼Ð¸ Ð¿Ð¾Ð»ÑÐ¼Ð¸.\n"
        "Ð’Ñ‹Ð±ÐµÑ€Ð¸ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ ÑÐµÑ‚ÐºÐ¸ Ð½Ð¸Ð¶Ðµ Ð¸ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÑŒ Ñ„Ð¾Ñ‚Ð¾ ðŸ“·",
        reply_markup=menu
    )

@dp.message_handler(lambda msg: msg.text in ["ðŸŸ¦ Ð¡ÐµÑ‚ÐºÐ° 2Ã—2", "ðŸŸ© Ð¡ÐµÑ‚ÐºÐ° 3Ã—3", "ðŸŸ¥ Ð¡ÐµÑ‚ÐºÐ° 4Ã—4"])
async def set_grid(message: types.Message):
    sizes = {"ðŸŸ¦ Ð¡ÐµÑ‚ÐºÐ° 2Ã—2": 2, "ðŸŸ© Ð¡ÐµÑ‚ÐºÐ° 3Ã—3": 3, "ðŸŸ¥ Ð¡ÐµÑ‚ÐºÐ° 4Ã—4": 4}
    user_grid_choice[message.from_user.id] = sizes[message.text]
    await message.answer(f"âœ… Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚ {message.text} Ð²Ñ‹Ð±Ñ€Ð°Ð½.\nÐžÑ‚Ð¿Ñ€Ð°Ð²ÑŒ Ñ„Ð¾Ñ‚Ð¾ Ð´Ð»Ñ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸.")

@dp.message_handler(content_types=["photo"])
async def process_photo(message: types.Message):
    user_id = message.from_user.id
    if user_id not in user_grid_choice:
        await message.answer("âš  Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° Ð²Ñ‹Ð±ÐµÑ€Ð¸ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ ÑÐµÑ‚ÐºÐ¸.", reply_markup=menu)
        return

    grid_size = user_grid_choice[user_id]

    # Ð¡ÐºÐ°Ñ‡Ð¸Ð²Ð°ÐµÐ¼ Ñ„Ð¾Ñ‚Ð¾
    photo = await message.photo[-1].download(destination_file=BytesIO())
    photo.seek(0)
    img = Image.open(photo).convert("RGB")

    # Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð±ÐµÐ»Ñ‹Ðµ Ð¿Ð¾Ð»Ñ ÑÐ²ÐµÑ€Ñ…Ñƒ Ð¸ ÑÐ½Ð¸Ð·Ñƒ
    desired_ratio = 1  # ÐºÐ²Ð°Ð´Ñ€Ð°Ñ‚
    img_w, img_h = img.size
    current_ratio = img_w / img_h
    if current_ratio > desired_ratio:
        new_h = int(img_w / desired_ratio)
        padding = (new_h - img_h) // 2
        img = ImageOps.expand(img, border=(0, padding, 0, padding), fill="white")
    elif current_ratio < desired_ratio:
        new_w = int(img_h * desired_ratio)
        padding = (new_w - img_w) // 2
        img = ImageOps.expand(img, border=(padding, 0, padding, 0), fill="white")

    # ÐÐ°Ñ€ÐµÐ·ÐºÐ° Ñ„Ð¾Ñ‚Ð¾
    w, h = img.size
    piece_w = w // grid_size
    piece_h = h // grid_size
    pieces = []

    for row in range(grid_size):
        for col in range(grid_size):
            left = col * piece_w
            top = row * piece_h
            right = left + piece_w
            bottom = top + piece_h
            crop = img.crop((left, top, right, bottom))

            buf = BytesIO()
            crop.save(buf, format="JPEG")
            buf.seek(0)
            pieces.append(types.InputMediaPhoto(buf))

    await message.answer_media_group(pieces)

if __name__ == "__main__":
    executor.start_polling(dp, skip_updates=True)
